# .cursorrules - BZ Technologies (Node.js/TypeScript)
#
# üìã This file is a distributed copy of the master coding standards.
# üìñ Master Copy: /home/dkentjordan/bztech/code/.cursorrules (workspace root)
# üîÑ To update: 
#    1. Edit the master file: /home/dkentjordan/bztech/code/.cursorrules
#    2. Run: bzt-architecture/standards/sync-cursorrules.sh
# üìÖ Last Synced: 2025-12-21 22:50:35 CST
#
# --------------------------------------------------------------------------------

#
# üìÖ Last Updated: 2025-12-22 05:30:00 CST
# ‚ö†Ô∏è Remember to update this timestamp when making changes!
#
# --------------------------------------------------------------------------------
# ü§ñ AI ASSISTANT ACCESS REFERENCE
# --------------------------------------------------------------------------------
# When accessing systems, network devices, or Vault, ALWAYS reference:
# - /home/dkentjordan/bztech/code/bzt-architecture/infrastructure/security/AI-ACCESS-REFERENCE.md
# 
# This document contains:
# - Vault access patterns (address, login, credentials location)
# - SSH access methods for all servers
# - Database access procedures and credentials
# - Network device access (MikroTik)
# - Common workflows and troubleshooting
# - Quick reference commands
#
# Before attempting to SSH, access Vault, or connect to databases, check this reference first.

# --------------------------------------------------------------------------------
# üîê SERVER ACCESS CREDENTIALS - CRITICAL
# --------------------------------------------------------------------------------
# IMPORTANT: The account "dkentjordan" does NOT exist on BZ Technologies servers.
# 
# Correct accounts for server access:
# - **bzadmin** - Interactive login account (then use `su -` to become root)
# - **bzt-infra-automation** - Automation account with SSH keys (stored in Vault)
#
# SSH Key Location: Vault at `secret/infrastructure/automation/bzt-infra-automation-{server}`
# Example: `vault kv get -field=ssh_private_key secret/infrastructure/automation/bzt-infra-automation-bzt-tst-01`
#
# NEVER use "dkentjordan" as a username for server access - it does not exist.

# --------------------------------------------------------------------------------
# üí∞ RESOURCE & SCOPE GUARD (Pro+ Credit Protection)
# --------------------------------------------------------------------------------
# GOAL: Prevent accidental "token burning" on massive, ill-defined requests.
When analyzing a request:
1. **Estimate Scope:** Does this change affect > 5 files or require reading > 500 lines of active context?
2. **Warning Trigger:** If YES, you must preface your response with:
   "‚ö†Ô∏è **HIGH LOAD WARNING:** This operation has a large scope (approx. [X] files). Ensure 'Max Mode' is enabled and you have sufficient credits."
3. **Refusal to "YOLO":** Do not attempt to refactor the entire codebase in one turn. If the request is too broad (e.g., "Refactor all error handling"), propose a plan to tackle one module at a time.

# --------------------------------------------------------------------------------
# üß† GEMINI 3.0 HIGH-REASONING ENFORCER
# --------------------------------------------------------------------------------
When using gemini-3.0-pro or gemini-3.0-pro-preview:
1. **ALWAYS** engage "Deep Think" mode.
2. **MANDATORY:** Before generating code, output a <thinking> block to evaluate:
   * **Scope:** (As per Resource Guard above).
   * **Type Safety:** (Can we use strict interfaces instead of any?).
   * **Observability:** (Are we logging errors with context?).
3. Critique your own plan against the "BZ Design Pillars" below.

# --------------------------------------------------------------------------------
# üèõÔ∏è BZ DESIGN PILLARS (Ops & Support Focus)
# --------------------------------------------------------------------------------

# PILLAR 1: STRICT TYPESCRIPT & SAFETY
# We pay the tax upfront (types) to avoid debt later (runtime bugs).
- **NO `any` types.** Use `unknown` if unsure, then validate with type guards or Zod.
- Explicitly define return types for ALL functions.
- Prefer `interface` over `type` for object definitions (better error messages).
- Use Optional Chaining (`?.`) and Nullish Coalescing (`??`) over verbose checks.

# TENANT IDENTIFICATION RULE
# Critical distinction for multi-tenant architecture.
- **tenant_id**: Database ID (integer) - Use for ALL internal code, database queries, and service operations.
 - Example: `WHERE tenant_id = ?` in SQL queries
 - Example: `getTenantId()` returns tenant_id (integer)
 - NEVER use tenant_code in database operations
- **tenant_code**: Human-readable identifier (string, e.g., "ACME001") - Use ONLY for GUI displays and user-facing messages.
 - Example: Display "Customer: ACME001" in UI (see UI TERMINOLOGY RULE below)
 - Example: `getTenantCode()` returns tenant_code (string)
 - NEVER use tenant_code in database WHERE clauses or internal logic
- **JWT Token Note**: JWT field named "tenantId" actually contains tenant_code (for security). Middleware converts it to tenant_id for internal use.

# UI TERMINOLOGY RULE
# User-facing text must use "Customer" or "Client", not "Tenant".
- **Internal/Code**: Use "tenant" terminology in all code, variable names, function names, database fields, API endpoints, logs, comments, and internal documentation.
 - ‚úÖ Correct: `tenantId`, `getTenantId()`, `tenant_settings` table, `/api/admin/tenants`
 - ‚úÖ Correct: Log messages: "Error loading tenant", "Tenant not found"
- **UI/User-Facing**: Use "Customer" (or occasionally "Client") in ALL user-visible text:
 - ‚úÖ Correct: Page titles: "Customer Management", "Edit Customer"
 - ‚úÖ Correct: Labels: "Customer Code", "Customer ID", "Back to Customers"
 - ‚úÖ Correct: Messages: "Customer not found", "Failed to load customer"
 - ‚úÖ Correct: Table headers: "Customer", "Customer Name"
 - ‚ùå Wrong: "Tenant Management", "Tenant Code", "Back to Tenants" (in UI)
- **Admin vs Customer Portal**: 
 - Admin portal (internal BZ staff): Can use "Customer" or "Tenant" interchangeably, but prefer "Customer" for consistency
 - Customer portal (end users): MUST use "Customer" or "Client", never "Tenant"

# PROXMOX TEMPLATE DEPLOYMENT REMINDER
# When deploying new servers from bzt-deb12-template:
# 1. Template is on VLAN 20 (192.168.20.11) - MUST change to target VLAN/subnet
# 2. ALWAYS create firewall rules for new BZT infrastructure servers
# 3. Firewall rules MUST be inserted BEFORE rule 58 (rule 59 is start of drop rules)
# 4. Each server needs unique SSH keys (regenerate host keys and automation account key)
# 5. See: bzt-architecture/infrastructure/scripts/DEPLOY-NEW-SERVER-FROM-TEMPLATE.md for complete guide

# PILLAR 2: NODE.JS STABILITY & ASYNC
# Operations Priority: Do not crash the process.
- **Async/Await Only:** No callbacks. Use `util.promisify` if dealing with legacy libs.
- **Global Error Handling:** All HTTP routes must pass errors to a `next()` handler or central middleware.
- **Event Loop Protection:** Avoid heavy computation in the main thread; suggest worker threads if O(n) is high.

# PILLAR 3: LOGGING
# If it isn't logged, it didn't happen.
- Use structured logging (e.g., Winston/Pino). `console.log` is FORBIDDEN in production code.
- Log levels matter:
  - `error`: Action required immediately.
  - `warn`: Something odd happened, but we recovered.
  - `info`: Key business events (e.g., "OrderPlaced").
  - `debug`: Detailed developer info for troubleshooting.
- **Handled Exceptions:** Must include a human-readable comment/message explaining the error context.
- **Unhandled Exceptions:** Must explicitly state "UNHANDLED EXCEPTION" in the message and include the full stack trace in the metadata.
- All errors must include context: `logger.error('Failed to save user', { userId, error })`.

# PILLAR 4: OBSERVABILITY (Telemetry)
# Measure what matters.
- **Instrumentation:** Prepare code for integration with APM tools (DataDog, New Relic, OpenTelemetry).
- **Context Propagation:** Ensure trace IDs are passed between services and modules.
- **Metrics:** Track key performance indicators (latency, error rates, throughput).

# PILLAR 5: SECURITY & VALIDATION
# Trust nothing. Verify everything.
- **Input Validation:** All external inputs (API body, query params) must be validated (e.g., using Zod) before use.
- **Sanitization:** Sanitize all outputs to prevent XSS (Cross-Site Scripting).
- **Authentication:** Ensure endpoints are protected by appropriate middleware (e.g., `tenantMiddleware`).

# PILLAR 6: TESTING & AUTOMATION
# Verify behavior before deploying.
- **Unit Tests:** Business logic changes must include corresponding unit tests (e.g., Jest/Vitest).
- **Regression Testing:** Automated suites must run on every build to prevent re-occurrence of known bugs.
- **Automation:** Design tests to be automated within CI/CD pipelines.
- **E2E Testing:** Prefer automated E2E testing tools (e.g., Playwright, Selenium, Cypress) for critical user flows.

# PILLAR 7: DEPLOYMENT & IMMUTABILITY
# Treat servers as cattle, not pets.
- **Statelessness:** Application code must not store state locally (use Redis/DB). Local disks are ephemeral.
- **Config Separation:** Configuration lives in the Database (tenants/settings) or Environment Variables, NEVER in code.
- **Blue/Green Ready:** Design for zero-downtime swaps. Old containers die; new ones replace them.

# PILLAR 8: BZ DESIGN SYSTEM & UI STANDARDS
# AI must enforce these visual standards in all frontend code.
# 1. COLOR PALETTE (Strict Enforcement)
# Always use these specific Tailwind classes or Hex codes.
- Primary (Navy):   `bg-bzt-navy`  / #00205B (Headers, Footers, Primary Text)
- Accent (Gold):    `text-bzt-gold` / #EAAA00 (Highlight icons, active states)
- Buttons:          `bg-bzt-gold` text-`bzt-navy` hover:bg-white (High Contrast)
- Backgrounds:      `bg-slate-50` (App/Body background), `bg-white` (Cards/Panels)
# 2. COMPONENT RULES
- Navbar: Must be `bg-bzt-navy` with White text. Links hover to Gold.
- Footer: Must be `bg-bzt-navy` with White text.
- Cards: White background, rounded-lg, shadow-md, p-6.
- Headings: Navy color (#00205B), Font-Bold.
# 3. ICONOGRAPHY
- Library: FontAwesome 6 (via CDN).
- Usage: `<i className="fa-solid fa-{icon-name}"></i>`
- Styling: Icons often use `text-bzt-gold` for visual pop.
# 4. LAYOUT & SPACING
- Container: `max-w-7xl mx-auto px-4 sm:px-6 lg:px-8` (Standard wrapper)
- Grid: Use CSS Grid for dashboards (`grid-cols-1 md:grid-cols-3 gap-6`)

# --------------------------------------------------------------------------------
# üêô GITHUB & CODE MANAGEMENT STANDARDS
# --------------------------------------------------------------------------------
- **Modular Code:** Files should rarely exceed 200 lines with some flexibility for overage if the file isn't more than 50% over the limit. Break them down in a reasonable way.
- **Frontend Guidelines:**
  - Prefer React functional components.
  - Use Tailwind CSS utility classes over custom styles.
  - Use Server Components by default; only use "use client" when interactivity is required.
- **JSDoc/TSDoc:** All public methods must have comments explaining params and side effects.
- **Conventional Commits:** When suggesting commit messages, use the format: `feat(auth): add JWT validation`.

# --------------------------------------------------------------------------------
# üìÑ DOCUMENTATION & REPORT STANDARDS
# --------------------------------------------------------------------------------
- **Timestamps Required:** ALL markdown reports, status documents, and documentation files MUST include timestamps.
  - **Format**: `YYYY-MM-DD HH:MM:SS TZ` (e.g., `2025-12-21 08:01:00 CST`)
  - **Required Fields**: 
    - `**Generated**: <timestamp>` - When the document was first created
    - `**Last Updated**: <timestamp>` - When the document was last modified
  - **Location**: 
    - Header: Include immediately after the title/status line
    - Footer: Include at the end of the document before the final separator
  - **Examples**:
    ```markdown
    # Report Title
    
    **Generated**: 2025-12-21 08:01:00 CST  
    **Last Updated**: 2025-12-21 08:01:00 CST  
    **Status**: ‚úÖ Complete
    
    ... content ...
    
    ---
    
    **Report Generated**: 2025-12-21 08:01:00 CST  
    **Last Updated**: 2025-12-21 08:01:00 CST
    ```
  - **When to Update**: Always update `Last Updated` timestamp whenever modifying the document content.

# --------------------------------------------------------------------------------
# üåê NETWORK & SERVER ACCESS RULES
# --------------------------------------------------------------------------------
# CRITICAL: Always use FQDNs (Fully Qualified Domain Names) for server connections.
# The infrastructure uses MikroTik DNS server - short hostnames will not resolve.
# 
# ‚úÖ CORRECT: `bzt-tst-01.bztech.org`, `bz-vm-01.bztech.org`, `bzt-mon-01.bztech.org`
# ‚ùå WRONG: `bzt-tst-01`, `bz-vm-01`, `bzt-mon-01` (will fail to resolve)
#
# All servers must be accessed using the format: `<hostname>.bztech.org`
# IP addresses should only be used as fallback when DNS is unavailable.

# --------------------------------------------------------------------------------
# üö´ NEGATIVE CONSTRAINTS (The "Don't" List)
# --------------------------------------------------------------------------------
- DO NOT ignore TS compiler errors with `@ts-ignore`. Fix the root cause.
- DO NOT hardcode environment variables (use `process.env`).
- DO NOT leave "dead code" or commented-out blocks.
- DO NOT use short hostnames for server access - always use FQDNs (`server.bztech.org`).
